(function() {
    const source = {
        id: 'scanvf',
        name: 'Scan-VF',
        baseUrl: 'https://www.scan-vf.net',
        
        // 1. RECHERCHE / LISTE POPULAIRE
        async fetchMangaList(page = 1) {
            // Scan-VF utilise souvent une structure de type "filter" pour les populaires
            const url = `${this.baseUrl}/filterList?alpha=&genre=&status=&p=${page}`;
            const html = await window.__TAURI_INTERNALS__.invoke('fetch_html', { url });
            
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const mangas = [];

            // Sélecteur spécifique à Scan-VF pour la liste des mangas
            doc.querySelectorAll('.media').forEach(element => {
                const link = element.querySelector('a');
                const img = element.querySelector('img');
                const titleElement = element.querySelector('.media-heading');

                if (link && titleElement) {
                    mangas.push({
                        id: link.getAttribute('href').replace(`${this.baseUrl}/`, ''),
                        title: titleElement.innerText.trim(),
                        cover: img ? img.getAttribute('src') : '',
                        source_id: this.id
                    });
                }
            });

            return mangas;
        },

        // 2. DÉTAILS DU MANGA (ET CHAPITRES)
        async fetchMangaDetails(mangaId) {
            const url = `${this.baseUrl}/${mangaId}`;
            const html = await window.__TAURI_INTERNALS__.invoke('fetch_html', { url });
            
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            const chapters = [];
            // Les chapitres sont généralement dans une table ou une liste .chapters
            doc.querySelectorAll('.chapters li, .chapters tr').forEach(el => {
                const link = el.querySelector('a');
                if (link) {
                    chapters.push({
                        id: link.getAttribute('href').replace(`${this.baseUrl}/`, ''),
                        title: link.innerText.trim(),
                        date: '' // Optionnel
                    });
                }
            });

            return {
                title: doc.querySelector('h1')?.innerText.trim(),
                description: doc.querySelector('.manga-summary')?.innerText.trim(),
                chapters: chapters
            };
        },

        // 3. LECTURE DES PAGES
        async fetchChapterPages(chapterId) {
            const url = `${this.baseUrl}/${chapterId}`;
            const html = await window.__TAURI_INTERNALS__.invoke('fetch_html', { url });
            
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const pages = [];

            // Scan-VF charge souvent toutes les images d'un coup dans .img-responsive
            doc.querySelectorAll('.img-responsive').forEach(img => {
                const src = img.getAttribute('data-src') || img.getAttribute('src');
                if (src && src.includes('uploads')) {
                    pages.push(src.trim());
                }
            });

            return pages;
        }
    };

    // On expose l'objet pour que l'app puisse l'appeler
    window.extension_scanvf = source;
})();
